<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Nuestro Universo üíñ</title>
  <meta name="description" content="Un universo de palabras, solo para ti, mi amor üí´">
  <meta property="og:title" content="Nuestro Universo üíñ">
  <meta property="og:description" content="Un universo de palabras, solo para ti, mi amor üí´">
  <meta property="og:image" content="og-cover.png">
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    html,body{margin:0;height:100%;background:#020008;overflow:hidden}
    #galaxy-canvas{position:fixed;inset:0;width:100%;height:100%;display:block;touch-action:none}
    
    .pill{
      position:fixed;top:10px;left:50%;transform:translateX(-50%);padding:6px 14px;
      border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);
      color:#fff;font:13px -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial;
      text-shadow: 0 0 8px #fff, 0 0 16px #ffc0ff, 0 0 24px #ffc0ff;
      animation: pulse-glow 2.5s ease-in-out infinite;
    }
    @keyframes pulse-glow {
      0%, 100% { opacity: 0.9; transform: translateX(-50%) scale(1); }
      50% { opacity: 1; transform: translateX(-50%) scale(1.03); }
    }

    .attribution{
      position:fixed;left:10px;bottom:10px;font-size:11px;color:#b9a0ff;opacity:.8;
      background:rgba(0,0,0,.35);padding:6px 8px;border-radius:8px
    }

    .player{
      position:fixed;left:10px;right:10px;bottom:10px;display:flex;gap:8px;align-items:center;
      background:rgba(20,15,35,.45);border:1px solid rgba(220,180,255,.25);border-radius:12px;
      padding:8px; backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
      color:#fff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial;
      width: fit-content; 
      left: 50%;
      transform: translateX(-50%);
    }
    .player button{
      padding:8px 12px;border-radius:10px;
      border: 1px solid rgba(220, 180, 255, 0.25);
      background: rgba(220, 180, 255, 0.15);
      color:#fff; cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .player button:hover {
      background: rgba(220, 180, 255, 0.3);
      transform: scale(1.05);
    }
    .player input[type=file]{display:none}

    .error{
      position:fixed;inset:auto 10px 70px 10px;background:#260015;color:#ffcce5;
      border:1px solid #ff99dd;border-radius:10px;padding:10px;font:12px system-ui;display:none;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
<canvas id="galaxy-canvas"></canvas>
<div class="pill">feliz cumplea√±os 
                      mi:  üíõ</div>
<div class="attribution" style="left: 10px; transform: none;">Creado para Barby, mi universo üí´</div>
<div id="err" class="error"></div>

<div class="player">
  <button id="playBtn" title="Reproducir/Pausar m√∫sica" aria-label="Reproducir o pausar la m√∫sica">‚ñ∂Ô∏é</button>
  
  <audio id="audio" preload="auto" loop>
    <source src="5.mp3" type="audio/mpeg">
  </audio>
</div>

<canvas id="fx" style="position:fixed;inset:0;pointer-events:none;"></canvas>

<script>
(function(){
const err = document.getElementById('err');
function showError(msg){ err.textContent = msg; err.style.display='block'; }

// ====== AUDIO MODIFICADO ======
const audio = document.getElementById('audio');
const playBtn = document.getElementById('playBtn');

playBtn.onclick = async (e) => {
  // Marcamos la interacci√≥n manualmente para que no se duplique
  hasInteracted = true; 
  try { 
    if (audio.paused) { 
      await audio.play(); 
      playBtn.textContent='‚è∏Ô∏é'; 
    } else { 
      audio.pause(); 
      playBtn.textContent='‚ñ∂Ô∏é'; 
    } 
  }
  catch(e){ showError('Hubo un problema al reproducir la m√∫sica. üò¢'); }
};

// --- INICIO: Reproducir con la primera interacci√≥n ---
let hasInteracted = false;

async function startMusicOnInteraction(event) { // <-- Se a√±ade 'event'
  // --- INICIO: CORRECCI√ìN DE BUG ---
  // Si la interacci√≥n fue en el bot√≥n de Play, no hagas nada aqu√≠.
  // Se deja que el 'onclick' propio del bot√≥n (arriba) maneje la l√≥gica.
  if (event && (event.target === playBtn || playBtn.contains(event.target))) {
    return;
  }
  // --- FIN: CORRECCI√ìN DE BUG ---

  if (hasInteracted || !audio.paused) return; 
  hasInteracted = true;
  try {
    await audio.play();
    playBtn.textContent = '‚è∏Ô∏é';
  } catch (e) {
    console.warn("La reproducci√≥n autom√°tica fall√≥, se requiere clic en Play.", e);
  }
}

// Escuchadores para la *primera* interacci√≥n (click, toque, o tecla)
window.addEventListener('click', startMusicOnInteraction, { once: true, passive: true });
window.addEventListener('touchend', startMusicOnInteraction, { once: true, passive: true });
window.addEventListener('keydown', startMusicOnInteraction, { once: true, passive: true });
// --- FIN: Reproducir con la primera interacci√≥n ---


// ====== WEBGL CHECK ======
try { 
  const test = document.createElement('canvas').getContext('webgl') || document.createElement('canvas').getContext('experimental-webgl');
  if(!test) throw new Error('Tu navegador no tiene WebGL activo');
} catch(e) { showError('WebGL parece desactivado. Tu navegador no puede mostrar la magia... Prueba con Chrome/Edge/Firefox. üò¢'); return; }

// ====== THREE.JS GALAXY ======
try {
// Setup
const canvas = document.getElementById('galaxy-canvas');
const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:false });
renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.outputEncoding = THREE.sRGBEncoding;

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.dampingFactor = 0.06;
controls.minDistance = 10; controls.maxDistance = 220;
controls.target.set(0,0,0);

// Esta l√≠nea escucha el "arrastre" de la galaxia para iniciar la m√∫sica.
controls.addEventListener('start', startMusicOnInteraction, { once: true, passive: true });

// Camera default
function setCam(){
  const w = window.innerWidth, h = window.innerHeight;
  const isMobile = w < 768 || w < h;
  camera.fov = isMobile ? 90 : 75;
  camera.position.set(0, isMobile? 26 : 22, isMobile? 110 : 75);
  camera.updateProjectionMatrix(); controls.update();
} setCam();

// ---------- Prettier starfield texture (soft glow + variety) ----------
function makePrettyStarTexture(size=1024, count=2000) {
  const c = document.createElement('canvas'); c.width = c.height = size;
  const g = c.getContext('2d');
  const r = size/2;
  const bg = g.createRadialGradient(r,r, r*0.2, r,r, r);
  bg.addColorStop(0,'#08021a');
  bg.addColorStop(1,'#020008');
  g.fillStyle = bg; g.fillRect(0,0,size,size);
  for (let i=0;i<count;i++) {
    const x = Math.random()*size, y = Math.random()*size;
    const base = Math.random()*0.7 + 0.3;
    const glow = g.createRadialGradient(x,y,0, x,y, Math.random()*2.2+1.6);
    const huePick = Math.random();
    let colInner = 'rgba(255,255,255,'+(0.65*base)+')';
    let colOuter = 'rgba(180,190,255,'+(0.12*base)+')';
    if (huePick < 0.33) { 
      colOuter = 'rgba(255,180,240,'+(0.12*base)+')';
    } else if (huePick < 0.66) {
      colOuter = 'rgba(255,230,180,'+(0.12*base)+')';
    }
    glow.addColorStop(0, colInner);
    glow.addColorStop(1, colOuter);
    g.fillStyle = glow; g.beginPath(); g.arc(x,y, Math.random()*1.2+0.6, 0, Math.PI*2); g.fill();
  }
  return new THREE.CanvasTexture(c);
}

const bgGeo = new THREE.SphereGeometry(600, 64, 64);
const starTex = makePrettyStarTexture(1024, 2600);
starTex.wrapS = starTex.wrapT = THREE.RepeatWrapping;
const bg = new THREE.Mesh(bgGeo, new THREE.MeshBasicMaterial({ map: starTex, side: THREE.BackSide, transparent:false, opacity:0.95 }));
scene.add(bg);

// Galaxy
const galaxy = new THREE.Group(); scene.add(galaxy);
const phrases = [
  "Pinchecha ‚ú®", "Hermosa üíõ", "amiga", "enana üåå", "Hermosota ‚ú®", "pendeja ‚ôæÔ∏è",
  "enojona", "mordida ü•∞", "barby üí´", "Amorüíõ", "el pepe", "Unica üòä",
  "Reina üëë", " Amor", "mamasita", "agua üå†", "Ni√±a", "Mi amigisüíõ", "Mi estres",
  "marcadora", "chido", "persona linda", "Bombom", "favorita", "bola 8 ‚ôæÔ∏è",
  "un universo üåå", "una constelaci√≥n üå†", "Brillas m√°s que mil estrellas ‚ú®",
  "bruja üíñ", "pendeja x2 üëë", "Mi casualidad m√°s bonita ü•∞",
  "Juntos para siempre ‚ôæÔ∏è", " amor de lopez üíõ", "Mi lugar de estres üòä", "Eres mi magia negra üí´",
  "Mi ancla ‚öì", "Mi destino final", "Solo t√∫ üíñ", "Nuestra galaxia üåå", "Te elijo a ti como pokemon üíõ"
];

const phraseCount = Math.max(phrases.length * 6, 200);
const arms = 5, radius = 82, maxH = 22;

function makeTextTexture(text, size=48, index=0){
  const c=document.createElement('canvas'); c.width=1024; c.height=128;
  const g=c.getContext('2d'); g.clearRect(0,0,c.width,c.height);
  g.font='800 '+size+'px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial';
  g.textAlign='center'; g.textBaseline='middle';

  const hue = (index % 3);
  let shadowCol = 'rgba(230,160,255,0.95)';
  let fillCol = 'rgba(255,245,255,0.98)';
  if (hue === 1) {
    shadowCol = 'rgba(160,220,255,0.95)';
    fillCol = 'rgba(240,245,255,0.98)';
  } else if (hue === 2) {
    shadowCol = 'rgba(255,210,160,0.95)';
    fillCol = 'rgba(255,250,240,0.98)';
  }

  g.shadowColor = shadowCol; g.shadowBlur = 24;
  g.fillStyle = fillCol; g.fillText(text, c.width/2, c.height/2);
  return new THREE.CanvasTexture(c);
}

// --- MEJORA: Se a√±adieron comentarios para explicar la l√≥gica ---
for(let i=0; i < phraseCount; i++){ 
  const text = phrases[i % phrases.length];
  const tex = makeTextTexture(text, 48, i);
  
  const spr = new THREE.Sprite(new THREE.SpriteMaterial({ 
    map: tex, 
    transparent: true, 
    depthWrite: false, 
    blending: THREE.AdditiveBlending 
  }));
  spr.isPhrase = true;
  
  // --- L√≥gica de la galaxia espiral ---
  // Asigna la palabra a uno de los 'brazos'
  const perArm = phraseCount / arms;
  const ang = (i % perArm) * (Math.PI * 2 / perArm); // √Ångulo dentro del brazo
  const armAng = Math.floor(i / perArm) * (Math.PI * 2 / arms); // √Ångulo del brazo
  
  // La distancia desde el centro (m√°s denso en el centro)
  const dist = Math.pow(i / phraseCount, 0.72) * radius;
  
  // Grosor vertical (m√°s grueso cerca del centro)
  const thickness = Math.pow(1 - (dist / radius), 2);
  
  // Calcular posici√≥n (X, Y, Z)
  const x = Math.cos(ang + armAng) * dist;
  const z = Math.sin(ang + armAng) * dist;
  const y = (Math.random() - 0.5) * maxH * thickness * 0.9;
  
  spr.position.set(x, y, z); 
  spr.scale.set(20, 2.6, 1); // Escalar el sprite de texto
  galaxy.add(spr);
}
// --- Fin de la mejora ---

// Galaxy stars
const starCount=8000, geom=new THREE.BufferGeometry(), pos=new Float32Array(starCount*3);
for(let i=0;i<starCount;i++){ const ang=Math.random()*Math.PI*2, dist=Math.random()*radius*1.15;
  const y=(Math.random()-0.5)*36*Math.pow(1-Math.min(dist,radius)/radius,1.5);
  pos[i*3]=Math.cos(ang)*dist; pos[i*3+1]=y; pos[i*3+2]=Math.sin(ang)*dist; }
geom.setAttribute('position', new THREE.BufferAttribute(pos,3));
galaxy.add(new THREE.Points(geom, new THREE.PointsMaterial({ color:0xffffff, size:0.35, transparent:true, opacity:0.75, blending:THREE.AdditiveBlending })));

// Black hole
const coreR=12;
const coreTexCanvas=document.createElement('canvas'); coreTexCanvas.width=coreTexCanvas.height=256;
const cg=coreTexCanvas.getContext('2d'); const grd=cg.createRadialGradient(128,128,10,128,128,128);
grd.addColorStop(0,'#2a003a'); grd.addColorStop(0.6,'#100018'); grd.addColorStop(1,'#000');
cg.fillStyle=grd; cg.arc(128,128,128,0,Math.PI*2); cg.fill();
const core=new THREE.Mesh(new THREE.SphereGeometry(coreR,64,64), new THREE.MeshBasicMaterial({ map:new THREE.CanvasTexture(coreTexCanvas) }));
core.renderOrder=1; scene.add(core);

const photonRing=new THREE.Mesh(new THREE.RingGeometry(coreR*1.05, coreR*1.18, 128), new THREE.MeshBasicMaterial({ color:0xEAAEFF, transparent:true, opacity:0.95, side:THREE.DoubleSide }));
photonRing.rotation.x=-Math.PI/2; photonRing.renderOrder=0.5; scene.add(photonRing);

function makeHaloTexture(size=1024, inner=0.45){
  const c=document.createElement('canvas'); c.width=c.height=size; const g=c.getContext('2d'); const r=size/2;
  const grd=g.createRadialGradient(r,r,r*inner, r,r,r);
  grd.addColorStop(0.0,'rgba(255,200,240,0.45)');
  grd.addColorStop(0.35,'rgba(220,180,255,0.35)');
  grd.addColorStop(0.7,'rgba(160,200,255,0.28)');
  grd.addColorStop(1,'rgba(0,0,0,0)');
  g.fillStyle=grd; g.fillRect(0,0,size,size); const tex=new THREE.CanvasTexture(c); tex.needsUpdate=true; return tex;
}
const haloPlane=new THREE.Mesh(new THREE.PlaneGeometry(360,360), new THREE.MeshBasicMaterial({ map:makeHaloTexture(1024,0.45), transparent:true, depthWrite:false, blending:THREE.AdditiveBlending, opacity:0.9 }));
haloPlane.rotation.x=-Math.PI/2; haloPlane.renderOrder=0.2; scene.add(haloPlane);

let tw = 0;
function animate(){
  requestAnimationFrame(animate);
  const t = performance.now()*0.001;
  tw = (tw + 0.0003) % 1;
  starTex.offset.set(tw, 0);
  galaxy.rotation.y = t * 0.05;
  core.rotation.y = t * 0.12;
  
  const pulse = Math.sin(t * 1.5) * 0.08 + 1.0;
  photonRing.scale.set(pulse, pulse, 1);
  photonRing.material.opacity = 0.8 + Math.sin(t * 1.5) * 0.15;
  photonRing.rotation.z = t * 0.18;
  
  haloPlane.rotation.z = t * 0.02;
  controls.update();
  renderer.render(scene, camera);
} animate();

// ====== HEARTS OVERLAY (double tap/click) ======
const fx = document.getElementById('fx');
const ctx2 = fx.getContext('2d');
function resizeFx(){
  fx.width = Math.floor(innerWidth * Math.min(2, window.devicePixelRatio||1));
  fx.height = Math.floor(innerHeight * Math.min(2, window.devicePixelRatio||1));
  fx.style.width = innerWidth + 'px';
  fx.style.height = innerHeight + 'px';
}
addEventListener('resize', resizeFx); resizeFx();
const DPR = Math.min(2, window.devicePixelRatio || 1);
const hearts = [];
function spawnHearts(x,y,n=20){
  x *= DPR; y *= DPR;
  for(let i=0;i<n;i++){ const a=Math.random()*Math.PI*2;
    hearts.push({x,y,vx:Math.cos(a)*(0.6+Math.random()*0.8),vy:-(0.8+Math.random()*1.2),life:1,size:10+Math.random()*16});
  }
}
function drawHeart(x,y,size){
  const s=size; ctx2.save(); ctx2.translate(x,y);
  ctx2.beginPath(); ctx2.moveTo(0,-0.25*s);
  ctx2.bezierCurveTo(.5*s,-.9*s,1.4*s,-.1*s,0,.9*s);
  ctx2.bezierCurveTo(-1.4*s,-.1*s,-.5*s,-.9*s,0,-.25*s);
  const g=ctx2.createRadialGradient(0,0,0,0,0,s);
  g.addColorStop(0,'rgba(255,190,220,.95)'); g.addColorStop(1,'rgba(255,90,160,0)');
  ctx2.fillStyle=g; ctx2.fill(); ctx2.restore();
}
let lastTap=0;
addEventListener('click', (e)=>{ const now=performance.now(); if(now-lastTap<320) spawnHearts(e.clientX,e.clientY,20); lastTap=now; }, {passive:true});
addEventListener('touchend', (e)=>{ const now=performance.now(); const t=e.changedTouches&&e.changedTouches[0]; if(now-lastTap<320&&t) spawnHearts(t.clientX,t.clientY,20); lastTap=now; }, {passive:true});

function loopFx(){
  ctx2.clearRect(0,0,fx.width,fx.height);
  for(let i=hearts.length-1;i>=0;i--){ const h=hearts[i]; 
    h.x+=h.vx; h.y+=h.vy; h.vy-=0.02; 
    h.life-=0.012;
    h.vx += (Math.random() - 0.5) * 0.05;
    ctx2.globalAlpha=Math.max(0,h.life); drawHeart(h.x,h.y,h.size); ctx2.globalAlpha=1; if(h.life<=0) hearts.splice(i,1);
  }
  requestAnimationFrame(loopFx);
} loopFx();

} catch(e) { showError('Error cargando la galaxia: '+e.message); console.error(e); }
})();
</script>
</body>
</html>